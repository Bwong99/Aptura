{% load static %}

<!DOCTYPE html>
<link rel="stylesheet" href="{% static 'css/home.css' %}" />
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title> Aptura </title>
</head>
<body>

  <header>
    <h1>Aptura</h1>
    <nav>
      <a href="{% url 'index' %}">Welcome</a>
      {% if user.is_authenticated %}
        <a href="{% url 'profile' %}" class="profile-link">Profile</a>
        <a href="{% url 'create_post' %}">Post</a>
        <a href="{% url 'saved_posts' %}" class="saved-link">Saved Posts</a>
        <div class="notification-container">
          <button class="notification-bell" id="notificationBell">
            üîî
            {% if unread_notifications_count > 0 %}
              <span class="notification-badge" id="notificationBadge">{{ unread_notifications_count }}</span>
            {% endif %}
          </button>
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
              <h3>Notifications</h3>
              <button class="mark-read-btn" id="markReadBtn">Mark all as read</button>
            </div>
            <div class="notification-list" id="notificationList">
              <!-- Notifications will be loaded here -->
            </div>
          </div>
        </div>
      {% else %}
        <a href="{% url 'login' %}" class="login-link">Login</a>
      {% endif %}
    </nav>
  </header>

  <section id="hero">
    <h2>See other photographer's latest work</h2>
  </section>

  <section id="search">
    <div class="search-container">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search for photographers..." autocomplete="off">
        <button id="searchBtn">üîç</button>
      </div>
      <div class="search-results" id="searchResults">
        <!-- Search results will appear here -->
      </div>
    </div>
  </section>

  <section id="explore">
    <h2>Explore</h2>
    
    <!-- Page info -->
    {% if is_paginated %}
      <div class="page-info">
        <p>Page {{ page_obj.number }} of {{ paginator.num_pages }} ({{ paginator.count }} total posts)</p>
      </div>
    {% endif %}
    
    <div class="gallery" id="gallery">
      {% for post in posts %}
        <div class="post">
          <a href="{% url 'view_post' post.id %}">
            <img src="{{ post.photo.url }}" alt="{{ post.title }}">
            <div class="post-info">
              <a href="{% url 'view_user_profile' post.user.username %}" class="photographer">{{ post.user.username }}</a>
              <span class="photo-title">{{ post.title }}</span>
            </div>
          </a>
        </div>
      {% empty %}
        <div class="no-posts-message">
          <p>No posts yet. <a href="{% url 'create_post' %}">Be the first to share a photo!</a></p>
        </div>
      {% endfor %}
    </div>
    
    <!-- Pagination Controls -->
    {% if is_paginated %}
      <div class="pagination-container">
        <div class="pagination-controls">
          {% if page_obj.has_previous %}
            <a href="?page=1" class="page-btn first-page">&laquo; First</a>
            <a href="?page={{ page_obj.previous_page_number }}" class="page-btn prev-page">&lsaquo; Previous</a>
          {% endif %}
          
          <div class="page-numbers">
            {% for num in paginator.page_range %}
              {% if page_obj.number == num %}
                <span class="current-page">{{ num }}</span>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?page={{ num }}" class="page-btn">{{ num }}</a>
              {% endif %}
            {% endfor %}
          </div>
          
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="page-btn next-page">Next &rsaquo;</a>
            <a href="?page={{ paginator.num_pages }}" class="page-btn last-page">Last &raquo;</a>
          {% endif %}
        </div>
        
        <!-- Toggle between pagination and infinite scroll -->
        <div class="view-toggle">
          <button id="toggleInfiniteScroll" class="toggle-btn">
            <span id="toggleText">Switch to Infinite Scroll</span>
          </button>
        </div>
      </div>
    {% endif %}
    
    <!-- Loading indicator for infinite scroll -->
    <div class="loading-indicator" id="loadingIndicator" style="display: none;">
      <div class="spinner"></div>
      <p>Loading more posts...</p>
    </div>
    
    <!-- End of posts indicator -->
    <div class="end-of-posts" id="endOfPosts" style="display: none;">
      <p>No more posts to show</p>
    </div>
    
    <!-- Infinite scroll trigger -->
    <div id="scrollTrigger" style="height: 20px;"></div>
  </section>

  <script>
    // Notification functionality
    {% if user.is_authenticated %}
    const notificationBell = document.getElementById('notificationBell');
    const notificationDropdown = document.getElementById('notificationDropdown');
    const notificationList = document.getElementById('notificationList');
    const markReadBtn = document.getElementById('markReadBtn');

    notificationBell.addEventListener('click', function(e) {
      e.stopPropagation();
      notificationDropdown.style.display = notificationDropdown.style.display === 'block' ? 'none' : 'block';
      
      if (notificationDropdown.style.display === 'block') {
        loadNotifications();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
      notificationDropdown.style.display = 'none';
    });

    notificationDropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });

    function loadNotifications() {
      fetch('/get-notifications/')
        .then(response => response.json())
        .then(data => {
          if (data.notifications.length === 0) {
            notificationList.innerHTML = '<div class="no-notifications">No new notifications</div>';
          } else {
            let html = '';
            data.notifications.forEach(notification => {
              if (notification.notification_type === 'post' && notification.post_id) {
                html += `
                  <div class="notification-item" onclick="goToPost(${notification.post_id})">
                    <strong>${notification.sender_username}</strong> posted: "${notification.post_title}"
                    <div class="notification-time">${notification.created_at}</div>
                  </div>
                `;
              } else if (notification.notification_type === 'save' && notification.post_id) {
                html += `
                  <div class="notification-item" onclick="goToPost(${notification.post_id})">
                    <strong>${notification.sender_username}</strong> saved your post: "${notification.post_title}"
                    <div class="notification-time">${notification.created_at}</div>
                  </div>
                `;
              } else if (notification.notification_type === 'follow') {
                html += `
                  <div class="notification-item" onclick="goToProfile('${notification.sender_username}')">
                    <strong>${notification.sender_username}</strong> started following you
                    <div class="notification-time">${notification.created_at}</div>
                  </div>
                `;
              }
            });
            notificationList.innerHTML = html;
          }
        })
        .catch(error => {
          console.error('Error loading notifications:', error);
          notificationList.innerHTML = '<div class="no-notifications">Error loading notifications</div>';
        });
    }

    function goToPost(postId) {
      window.location.href = `/post/${postId}/`;
    }

    function goToProfile(username) {
      window.location.href = `/user/${username}/`;
    }

    markReadBtn.addEventListener('click', function() {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch('/mark-notifications-read/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const badge = document.querySelector('.notification-badge');
          if (badge) {
            badge.remove();
          }
          notificationDropdown.style.display = 'none';
          location.reload();
        }
      });
    });
    {% endif %}

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const searchResults = document.getElementById('searchResults');
    let searchTimeout;

    function performSearch(query) {
      if (query.trim() === '') {
        searchResults.style.display = 'none';
        return;
      }

      fetch(`/search-users/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          displaySearchResults(data.users);
        })
        .catch(error => {
          console.error('Error searching:', error);
        });
    }

    function displaySearchResults(users) {
      if (users.length === 0) {
        searchResults.innerHTML = '<div class="no-results">No photographers found</div>';
        searchResults.style.display = 'block';
        return;
      }

      let html = '';
      users.forEach(user => {
        html += `
          <div class="search-result-item" onclick="goToUserProfile('${user.username}')">
            <div class="user-avatar">
              ${user.profile_photo ? 
                `<img src="${user.profile_photo}" alt="${user.username}">` : 
                '<div class="default-avatar">üë§</div>'
              }
            </div>
            <div class="user-info">
              <strong>${user.username}</strong>
              <p>${user.display_name || user.username}</p>
              ${user.bio ? `<span class="user-bio">${user.bio.substring(0, 50)}${user.bio.length > 50 ? '...' : ''}</span>` : ''}
            </div>
          </div>
        `;
      });
      
      searchResults.innerHTML = html;
      searchResults.style.display = 'block';
    }

    function goToUserProfile(username) {
      window.location.href = `/user/${username}/`;
    }

    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      const query = this.value;
      
      searchTimeout = setTimeout(() => {
        performSearch(query);
      }, 300);
    });

    searchBtn.addEventListener('click', function() {
      performSearch(searchInput.value);
    });

    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        performSearch(this.value);
      }
    });

    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-container')) {
        searchResults.style.display = 'none';
      }
    });

    // Pagination and infinite scroll functionality
    let infiniteScrollEnabled = localStorage.getItem('infiniteScrollEnabled') === 'true';
    let currentPage = {% if page_obj %}{{ page_obj.number }}{% else %}1{% endif %};
    let totalPages = {% if paginator %}{{ paginator.num_pages }}{% else %}1{% endif %};
    let isLoading = false;
    let hasMorePosts = {% if page_obj %}{{ page_obj.has_next|yesno:"true,false" }}{% else %}false{% endif %};
    
    const gallery = document.getElementById('gallery');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const endOfPosts = document.getElementById('endOfPosts');
    const scrollTrigger = document.getElementById('scrollTrigger');
    const paginationContainer = document.querySelector('.pagination-container');
    const toggleBtn = document.getElementById('toggleInfiniteScroll');
    const toggleText = document.getElementById('toggleText');
    
    // Initialize view mode only if toggle button exists
    if (toggleBtn && toggleText) {
      updateViewMode();
    }
    
    // Intersection Observer for infinite scroll
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && infiniteScrollEnabled && !isLoading && hasMorePosts) {
          loadMorePosts();
        }
      });
    }, {
      threshold: 0.1
    });
    
    function updateViewMode() {
      if (infiniteScrollEnabled) {
        if (paginationContainer) paginationContainer.style.display = 'none';
        if (scrollTrigger) observer.observe(scrollTrigger);
        if (toggleText) toggleText.textContent = 'Switch to Pagination';
      } else {
        if (paginationContainer) paginationContainer.style.display = 'block';
        if (scrollTrigger) observer.unobserve(scrollTrigger);
        if (toggleText) toggleText.textContent = 'Switch to Infinite Scroll';
      }
    }
    
    if (toggleBtn) {
      toggleBtn.addEventListener('click', function() {
        infiniteScrollEnabled = !infiniteScrollEnabled;
        localStorage.setItem('infiniteScrollEnabled', infiniteScrollEnabled);
        updateViewMode();
        
        if (!infiniteScrollEnabled) {
          // Reload page to show proper pagination
          window.location.reload();
        }
      });
    }
    
    function loadMorePosts() {
      if (isLoading || !hasMorePosts || !infiniteScrollEnabled) return;
      
      isLoading = true;
      if (loadingIndicator) loadingIndicator.style.display = 'block';
      currentPage++;
      
      fetch(`/load-more-posts/?page=${currentPage}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.posts && data.posts.length > 0) {
            appendPosts(data.posts);
            hasMorePosts = data.has_more;
          } else {
            hasMorePosts = false;
          }
          
          if (!hasMorePosts) {
            if (endOfPosts) endOfPosts.style.display = 'block';
            if (scrollTrigger) observer.unobserve(scrollTrigger);
          }
        })
        .catch(error => {
          console.error('Error loading more posts:', error);
          currentPage--; // Revert page increment on error
          // Show user-friendly error message
          if (gallery) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = '<p>Failed to load more posts. Please try again.</p>';
            gallery.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
          }
        })
        .finally(() => {
          isLoading = false;
          if (loadingIndicator) loadingIndicator.style.display = 'none';
        });
    }
    
    function appendPosts(posts) {
      const noPostsMessage = document.querySelector('.no-posts-message');
      if (noPostsMessage) {
        noPostsMessage.remove();
      }
      
      posts.forEach(post => {
        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.innerHTML = `
          <a href="/post/${post.id}/">
            <img src="${post.photo_url}" alt="${post.title}" loading="lazy">
            <div class="post-info">
              <a href="/user/${post.username}/" class="photographer">${post.username}</a>
              <span class="photo-title">${post.title}</span>
            </div>
          </a>
        `;
        if (gallery) gallery.appendChild(postElement);
      });
    }
  </script>

  <!-- Add CSRF token for AJAX requests -->
  {% csrf_token %}

</body>
</html>



